name: Create a new release
on: 
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repo name to be released'
        required: true
      release:
        description: 'Release version'
        required: true
      secrets:
        description: 'Encrypted secrets to use for this task'
        required: true

jobs:
  create-release:
    name: Deploy staging environment
    runs-on: ubuntu-20.04
    steps:
      - id: checkout-ui
        name: Checkout ui repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          repository: biomage-ltd/ui
          ref: develop
          path: ui
          token: ${{ secrets.API_TOKEN_GITHUB }}

      - id: checkout-api
        name: Checkout API repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          repository: biomage-ltd/api
          ref: develop
          path: api
          token: ${{ secrets.API_TOKEN_GITHUB }}

      - id: checkout-pipeline
        name: Checkout pipeline repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          repository: biomage-ltd/pipeline
          ref: develop
          path: pipeline
          token: ${{ secrets.API_TOKEN_GITHUB }}

      - id: checkout-worker
        name: Checkout worker repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          repository: biomage-ltd/worker
          ref: develop
          path: worker
          token: ${{ secrets.API_TOKEN_GITHUB }}


      - id: disable-admin-enforcement
        name: Temporarily disable admin enforcement
        uses: benjefferies/branch-protection-bot@master
        with:
          access-token: ${{ secrets.API_TOKEN_GITHUB }}
          owner: biomage-ltd
          repo: iac
          enforce_admins: false
          retries: 8

      - id: create-release
        name: Create the new release.
        run: |-
            cd ${REPO}

            git checkout ${RELEASE_BRANCH}
            git checkout develop 

            # We check for differences because ${RELEASE_BRANCH} and develop are in different commits (due to merge) so git log is never empty.
            if [ "$(git diff ${RELEASE_BRANCH}..develop)" = "" ]; then
              echo " * No changes detected between ${RELEASE_BRANCH} and develop."
            else
              echo " * Found changes between ${RELEASE_BRANCH} and develop. Commits found: "
              echo "$(git log --pretty=format:%s ${RELEASE_BRANCH}..develop | xargs -I % sh -c 'echo "\t- %";' )"
              echo ""
            fi

            git config user.name "Github Actions"

            echo "==> Creating ${RELASE} from $(git branch --show-current) branch"
            git config --local "gitflow.branch.release/${RELEASE}.base" develop
            git checkout -b "release/${RELEASE}" develop
 
            git checkout ${RELEASE_BRANCH}
            git merge --no-edit --no-ff "release/${RELEASE}"
            git checkout ${RELEASE_BRANCH}
            git tag -a "${RELEASE}" -m ''

            git checkout develop
            git merge --no-edit --no-ff "${RELEASE}"

            # push release commits
            git push origin ${RELEASE_BRANCH} develop
            # push force tag to allow re-releasing 
            git push origin refs/tags/${RELEASE} --force
        env:
          RELEASE: ${{ github.event.inputs.release }}
          RELEASE_BRANCH: "master"
          REPO: ${{ github.event.inputs.repo }}
      
      - id: enable-admin-enforcement
        name: Re-enable admin enforcement
        uses: benjefferies/branch-protection-bot@master
        if: always()
        with:
          access-token: ${{ secrets.API_TOKEN_GITHUB }}
          owner: biomage-ltd
          repo: iac
          enforce_admins: true
          retries: 8
