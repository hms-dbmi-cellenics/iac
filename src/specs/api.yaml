openapi: 3.0.0
info:
  title: API
  version: 1.0.0
  description: The main Node.js pipeline API.
  license:
    name: MIT
    url: 'https://github.com/biomage-ltd/api/blob/master/LICENSE'
  contact:
    name: Biomage Ltd.
servers:
  - url: /v1
tags:
  - name: experiments
    description: Manage your experiments and experiment details.
  - name: heartbeat
    description: API health checks.
  - name: work
    description: Submitting and receiving work.
  - name: processing-config
    description: Structure for configuration of processing steps.
paths:
  /health:
    get:
      tags:
        - heartbeat
      summary: API health check
      operationId: checkHealth
      x-eov-operation-id: 'health#check'
      x-eov-operation-handler: routes/health
      responses:
        '200':
          description: API is available.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    pattern: up
                  env:
                    type: string
                    enum:
                      - development
                      - test
                      - staging
                      - production
                  clusterEnv:
                    type: string
                    enum:
                      - development
                      - test
                      - staging
                      - production
                required:
                  - status
                  - env
                  - clusterEnv
      description: Returns a status on the health of the API.
  /workResults:
    post:
      operationId: receiveWork
      x-eov-operation-id: 'work#response'
      x-eov-operation-handler: routes/work
      requestBody:
        description: The data sent by AWS SNS.
        required: true
        content:
          text/plain:
            schema:
              type: string
            examples: {}
          application/json:
            schema:
              type: object
              properties: {}
            examples: {}
      responses:
        '200':
          description: 'A JSON-parseable was received by the server, *irrespective of whether it was correct/acceptable or not*.'
          content:
            text/plain:
              schema:
                type: string
                pattern: ok
        '500':
          description: The data sent by the server could not be parsed as JSON.
          content:
            text/plain:
              schema:
                type: string
                pattern: nok
      description: |-
        Results from work performed by workers are relayed to the API through this endpoint.

        Note that this endpoint is only exposed to AWS SNS, and since it has a specific communication protocol with limited feedback, the schema defined here is designed to be liberally enforceable. This endpoint is also used by SNS to handle subscribe/unsubscribe events.

        The actual JSON passed by SNS is found in the `WorkResponse` model, which is to be validated by the API.
      summary: Retrieve results from worker
      tags:
        - work
    parameters: []
  '/experiments/{experimentId}':
    get:
      tags:
        - experiments
      summary: Get experiment details
      description: Returns the main details of the experiment.
      operationId: getExperimentById
      x-eov-operation-id: 'experiment#findByID'
      x-eov-operation-handler: routes/experiment
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: ./models/api-response-schemas/Experiment.v1.yaml
        '404':
          description: Experiment not found
          content:
            application/json:
              schema:
                $ref: ./models/HTTPError.v1.yaml
    parameters:
      - schema:
          type: string
        name: experimentId
        in: path
        required: true
        description: ID of the experiment to find.
  '/experiments/{experimentId}/cellSets':
    get:
      tags:
        - experiments
      summary: Get cell sets for experiment
      description: Returns a hirearchical view of cell sets in the experiment.
      operationId: getExperimentCellSetsById
      x-eov-operation-id: 'experiment#getCellSets'
      x-eov-operation-handler: routes/experiment
      responses:
        '200':
          description: 'Request successful, hierarchy returned below.'
          content:
            application/json:
              schema:
                type: object
                properties:
                  cellSets:
                    type: array
                    items:
                      $ref: ./models/api-response-schemas/CellSets.v1.yaml
        '404':
          description: Experiment not found.
          content:
            application/json:
              schema:
                $ref: ./models/HTTPError.v1.yaml
    parameters:
      - name: experimentId
        in: path
        description: ID of experiment to find cell sets of.
        required: true
        schema:
          type: string
    put:
      summary: ''
      operationId: updateExperimentCellSetsById
      x-eov-operation-id: 'experiment#updateCellSets'
      x-eov-operation-handler: routes/experiment
      responses:
        '200':
          description: Update to object in response successful.
          content:
            application/json:
              schema:
                type: array
                items:
                  allOf:
                    - $ref: ./models/api-response-schemas/CellSets.v1.yaml
      description: Updates the cell set information in the database with a modified tree.
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                allOf:
                  - $ref: ./models/api-response-schemas/CellSets.v1.yaml
      tags:
        - experiments
  '/experiments/{experimentId}/processingConfig':
    get:
      summary: Retrieve processing configuration
      description: Returns a hirearchical view of processing configuration used in the experiment.
      operationId: getExperimentProcessingConfigById
      x-eov-operation-id: 'experiment#getProcessingConfig'
      x-eov-operation-handler: routes/experiment
      responses:
        '200':
          description: 'Fetch successful, response below.'
          content:
            application/json:
              schema:
                $ref: ./models/ProcessingConfig.v1.yaml
        '404':
          description: Experiment not found.
          content:
            application/json:
              schema:
                $ref: ./models/HTTPError.v1.yaml
      tags:
        - processing-config
    parameters:
      - name: experimentId
        in: path
        description: ID of experiment to find cell sets of.
        required: true
        schema:
          type: string
    put:
      summary: ''
      operationId: updateExperimentProcessingConfigById
      x-eov-operation-id: 'experiment#updateProcessingConfig'
      x-eov-operation-handler: routes/experiment
      responses:
        '200':
          description: Update to object in response successful.
          content:
            application/json:
              schema:
                $ref: ./models/ProcessingConfig.v1.yaml
              examples: {}
      description: Updates the processing configuration in the database.
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                type: object
                properties:
                  name:
                    type: string
                    description: Name of the configuration that wants to be changed
                  body:
                    $ref: ./models/ProcessingConfigBodies.v1.yaml
                required:
                  - name
                  - body
            examples: {}
        description: Updates the keys specified by `name` with the body specified by `body`. A standard DynamoDB UpdateItem request should be called on the update.
      tags:
        - processing-config
  '/experiments/{experimentId}/plots-tables/{plotUuid}':
    parameters:
      - schema:
          type: string
        name: plotUuid
        in: path
        required: true
      - schema:
          type: string
        name: experimentId
        in: path
        required: true
    put:
      summary: ''
      operationId: updatePlotTable
      x-eov-operation-id: 'plots-tables#update'
      x-eov-operation-handler: routes/plots-tables
      responses:
        '200':
          description: Update to object in response successful.
          content:
            application/json:
              schema:
                $ref: ./models/api-response-schemas/CellSets.v1.yaml
        '201':
          description: New resource created.
          content:
            application/json:
              schema:
                $ref: ./models/api-response-schemas/PlotTableConfig.v1.yaml
        '404':
          description: Invalid experiment ID specified.
      description: Updates a plot and table for a given experiment with the data specified.
      requestBody:
        content:
          application/json:
            schema:
              $ref: ./models/api-response-schemas/CellSets.v1.yaml
        description: The new configuration to update the old one by.
    get:
      summary: ''
      operationId: getPlotTable
      x-eov-operation-id: 'plots-tables#read'
      x-eov-operation-handler: routes/plots-tables
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: ./models/api-response-schemas/CellSets.v1.yaml
      description: Reads a plot and table for a given experiment with the data specified.
    delete:
      summary: ''
      operationId: deletePlotTable
      x-eov-operation-id: 'plots-tables#delete'
      x-eov-operation-handler: routes/plots-tables
      responses:
        '200':
          description: OK
      description: Deletes a plot and table for a given experiment with the data specified.
  '/experiments/{experimentId}/pipelines':
    parameters:
      - schema:
          type: string
        name: experimentId
        in: path
        required: true
    post:
      summary: Create a new pipeline for taks execution
      operationId: createNewPipeline
      x-eov-operation-id: 'pipelines#create'
      x-eov-operation-handler: routes/pipelines
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties: {}
      description: This path will create a new pipeline that can run a state machine with different bioinformatics tasks.
components:
  schemas:
    dummy:
      title: dummy
      type: object
      properties:
        id:
          type: string
